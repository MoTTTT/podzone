<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Martin Colley" /><link rel="canonical" href="https://musings.thruhere.net/podzone/technicalCodeSnippets/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Command line snippets - Podzone</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Command line snippets";
        var mkdocs_page_input_path = "technicalCodeSnippets.md";
        var mkdocs_page_url = "/podzone/technicalCodeSnippets/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Podzone
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Radio</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementRadio/">Radio Requirements</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalRadio/">Radio implementations</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesRadio/">Radio References</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Requirements</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementIntroduction/">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementBackground/">Background</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementBusinessBrief/">QApps Business Brief</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Analysis</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalConsumerCloud/">Consumer Cloud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalExternalServices/">External Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventorySite/">Site Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTasklist1/">Task List: southern.podzone.net</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTasklist2/">Task List: northern.podzone.net</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryCosting/">Costing</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalKubernetes/">Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalSound/">Sound Engineering</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalHardware/">Hardware planning</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Workload</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalSiteStructure/">Podzone Sites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalStaticSite/">Helm Charts</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalFlux/">Flux</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalWordpress/">Installing Wordpress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalApplication/">Application Build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIoT/">Rust on the uNode embedded controller development board</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalRedmine/">Redmine</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Troubleshooting</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTroubleshooting/">Radio Troubleshooting</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Substrate</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalCluster/">Implementation Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalCeph/">Persistent data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIngress/">Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalNFS/">NFS storage</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalNetwork/">Network Topology</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalProxy/">Reverse proxy</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIssues/">Issues</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Tools</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTools/">Tools</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalPrometheus/">Prometheus Implementation Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalWireguard/">Wireguard installation notes</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Inventory</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryServers/">Server Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryHosts/">Hosts Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryIoT/">IoT (Internet of Things) devices</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryVm/">Virtual Machine Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryWorkstation/">Workstation config</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesApplication/">Application references</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesHardware/">Hardware References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesIoT/">Edge and IoT References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesResearch/">Research References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesReserve/">Reserve References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesTroubleshooting/">Troubleshooting References</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Podzone</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Command line snippets</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="command-line-snippets">Command line snippets</h1>
<h2 id="network-port-forwarding">Network port forwarding</h2>
<p>Port forwarding from the ISP router to a metallbr listener on a machine running behind a wifi ethernet extender was not functional. This required the <code>top-of-web</code> router - which reverse-proxies http/s traffic to the various clusters - to be moved to a wired connection on the ISP router. The non-http/s traffic (icecast etc) had similar issues, and port forwarding on the top-of-web router was therefore added.</p>
<ul>
<li>Enable IP Forwarding: <code>net.ipv4.ip_forward = 1</code> in <code>/etc/sysctl.conf</code>, and apply changes: <code>sysctl -p</code></li>
<li>
<p>Install IP Tables: <code>apt install iptables-persistent</code></p>
</li>
<li>
<p>For rudolfensis, with ethernet port <code>enp1s0</code>, to route ports 8000 to 8002 to metallb listener <code>192.168.1.200</code>.</p>
</li>
</ul>
<pre><code class="language-bash">iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 8000 -j DNAT --to-destination 192.168.1.200:8000
iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 8001 -j DNAT --to-destination 192.168.1.200:8001
iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 8002 -j DNAT --to-destination 192.168.1.200:8002
iptables -t nat -A POSTROUTING -j MASQUERADE
</code></pre>
<ul>
<li>Save the rules: <code>iptables-save &gt; /etc/iptables/rules.v4</code></li>
<li>Check the rules: <code>iptables -t nat -nvL</code></li>
</ul>
<h3 id="notes">Notes</h3>
<ul>
<li>Port scanning reported the forwarded ports correctly, but browser requests timed out.</li>
<li>It is understood from hints in the documentation that port forwarding needs to be to a DHCP client of the router.</li>
<li>The wifi extender has it's own DHCP server, by default running in <code>auto</code> mode. Disabling the DHCP function in the management console did not change the behaviour, and new devices were still issued IPs by the wifi extender.</li>
</ul>
<h3 id="references">References</h3>
<ul>
<li><a href="https://chrisshennan.com/blog/using-iptables-to-forward-ports">https://chrisshennan.com/blog/using-iptables-to-forward-ports</a></li>
</ul>
<h2 id="flux">Flux</h2>
<p><code>flux bootstrap github --token-auth --owner=MoTTTT --repository=admin --branch=main --path=clusters/my-cluster --personal</code></p>
<h2 id="git">git</h2>
<ul>
<li>Push cloned repo to personal account: <code>git remote set-url origin http://github.com/YOU/YOUR_REPO</code></li>
</ul>
<h2 id="microk8s">microk8s</h2>
<ul>
<li><code>sudo snap install microk8s --channel=1.28/stable --classic</code></li>
<li><code>sudo usermod -a -G microk8s $USER</code></li>
<li><code>mkdir -p ~/.kube</code></li>
<li><code>chmod 0700 ~/.kube</code></li>
</ul>
<h2 id="helm">helm</h2>
<ul>
<li><code>helm repo add truecharts https://charts.truecharts.org/</code></li>
<li><code>helm pull [chart URL | repo/chartname] [...] [flags]</code></li>
<li><code>helm package static-site</code></li>
<li><code>cloudsmith push helm q-solutions/static-site static-site-0.1.0.tgz</code></li>
<li><code>helm  install musings-01 --debug  --namespace musings --create-namespace static-site --repo 'https://dl.cloudsmith.io/public/q-solutions/static-site/helm/charts/'</code></li>
<li><code>helm install podzone-01 --debug --namespace podzone --create-namespace --values valuespodzone.yaml .</code></li>
<li><code>helm  install podzone-01 --debug  --namespace podzone static-site --repo 'https://dl.cloudsmith.io/public/q-solutions/static-site/helm/charts/' -f values.yaml - --values valuespodzone.yaml</code></li>
</ul>
<h2 id="ceph">ceph</h2>
<ul>
<li><code>sudo ceph config set mgr mgr/prometheus/server_addr sigiriya</code></li>
<li><code>sudo ceph config set mgr mgr/prometheus/port 9090</code></li>
<li><a href="https://docs.ceph.com/en/quincy/rados/operations/pools/#create-a-pool">https://docs.ceph.com/en/quincy/rados/operations/pools/#create-a-pool</a></li>
<li><code>mount.ceph name@07fe3187-00d9-42a3-814b-72a4d5e7d5be.fs_name=/ /mnt/mycephfs -o mon_addr=1.2.3.4</code></li>
<li><code>sudo pro attach C13Nfcn8of2NLX4ZQbpN3zkEcT3WJZ</code></li>
<li>Mount apple volume - <code>./apfs-fuse /dev/sdb2 /mt/sdb1</code></li>
</ul>
<h2 id="kubectl">kubectl</h2>
<ul>
<li><code>kubectl config set-context --current --namespace=&lt;namespace-name&gt;</code></li>
<li><code>kubectl config set-context --current --namespace=admin</code></li>
<li><code>kubectl drain --ignore-daemonsets &lt;node name&gt;</code></li>
<li><code>kubectl uncordon &lt;node name&gt;</code></li>
<li><code>kubectl get -n default serviceaccount kubeapps-operator -o yaml</code></li>
<li><code>kubectl get pods --all-namespaces -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort | uniq -c</code></li>
<li>Aliases: <code>alias ka="kubectl apply -f "</code>; <code>alias kd="kubectl delete -f "</code></li>
<li><code>kubectl api-resources</code></li>
<li>Install bash completion on mac: <code>brew install bash-completion</code></li>
<li><code>source /opt/homebrew/etc/bash_completion</code></li>
<li><code>source &lt;(kubectl completion bash)</code> # set up autocomplete in bash into the current shell, bash-completion package should be installed first.</li>
<li><code>echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</code> # add autocomplete permanently to your bash shell.</li>
</ul>
<h2 id="ansible">ansible</h2>
<ul>
<li><code>ansible southcluster -i inventory.yaml -m command -a "free -m"</code></li>
<li>To accept new ssh keys: <code>- ANSIBLE_HOST_KEY_CHECKING=false ansible all -m ping -i inventory.yaml</code></li>
<li><code>ansible-playbook -i inventory.yaml playbook.yaml</code></li>
<li><code>ansible-inventory -i inventory.yaml --list</code></li>
<li><code>ansible devcluster -m ping -i inventory.yaml</code></li>
<li><code>ansible-playbook -i inventory.yaml playbook-install-nfsclient.yaml</code></li>
</ul>
<pre><code class="language-text">- name: Install the package &quot;foo&quot;
  ansible.builtin.apt:
    name: foo
</code></pre>
<h2 id="apache">apache</h2>
<ul>
<li>enable site: <code>a2ensite radio</code></li>
<li><code>sudo systemctl restart apache2</code></li>
<li><code>sudo apachectl configtest</code></li>
<li><code>sudo apache2ctl -t</code></li>
</ul>
<h2 id="plone">plone</h2>
<ul>
<li><code>/usr/local/Plone/Python-2.7/bin/python /usr/local/Plone/zinstance/parts/instance/bin/interpreter /usr/local/Plone/buildout-cache/eggs/zdaemon-2.0.7-py2.7.egg/zdaemon/zdrun.py -S /usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/zopeschema.xml -b 10 -d -s /usr/local/Plone/zinstance/var/instance/zopectlsock -x 0,2 -z /usr/local/Plone/zinstance/parts/instance /usr/local/Plone/Python-2.7/bin/python /usr/local/Plone/zinstance/parts/instance/bin/interpreter /usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/run.py -C /usr/local/Plone/zinstance/parts/instance/etc/zope.conf /usr/local/Plone/Python-2.7/bin/python</code></li>
<li><code>/usr/local/Plone/zinstance/parts/instance/bin/interpreter</code></li>
<li><code>/usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/run.py -C /usr/local/Plone/zinstance/parts/instance/etc/zope.conf</code></li>
<li><code>docker pull robcast/legacy-zope</code></li>
<li><code>docker pull robcast/legacy-zope:2.13</code></li>
<li><code>sudo usermod -aG sudo c</code></li>
</ul>
<h2 id="vagrant">Vagrant</h2>
<ul>
<li><code>vagrant init techchad2022/ubuntu2204</code></li>
<li><code>vagrant up</code></li>
<li><code>useradd -p &lt;password&gt; &lt;username&gt;</code></li>
<li><code>vagrant destroy</code></li>
<li><code>echo vagrant ALL=NOPASSWD:ALL &gt; /etc/sudoers.d/vagrant</code></li>
<li><code>echo colleymj ALL=NOPASSWD:ALL &gt; /etc/sudoers.d/colleymj</code></li>
<li>To allow IP to be assigned via DHCP simply use: <code>config.vm.network "public_network"</code></li>
<li>This way you don't need to deal with mac address, it will be generated on its own.</li>
<li>If you need custom mac address attached to the network device then: <code>config.vm.network "public_network", :mac=&gt; "080027xxxxxx"</code></li>
</ul>
<h2 id="network-wi-fi-hot-spot">Network, wi-fi hot-spot</h2>
<ul>
<li><code>sudo nmcli connection add type bridge con-name 'Bridge' ifname bridge0</code></li>
<li><code>sudo nmcli connection add type ethernet slave-type bridge con-name 'Ethernet' ifname eth0 master bridge0</code></li>
<li><code>sudo nmcli connection add con-name 'Hotspot' ifname wlan0 type wifi slave-type bridge master bridge0 wifi mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk wifi-sec.proto rsn wifi-sec.pairwise ccmp wifi-sec.psk 61519400</code></li>
<li><code>sudo nmcli connection add type ethernet slave-type bridge   con-name 'Ethernet' ifname eth0 master bridge0</code></li>
<li><code>sudo nmcli connection add con-name 'Hotspot'  ifname wlan0 type wifi slave-type bridge master bridge0  wifi.mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk wifi-sec.proto rsn wifi-sec.pairwise ccmp wifi-sec.psk 61519400</code></li>
<li><code>sudo nmcli device wifi hotspot ssid podzone password xxx11111</code></li>
<li><code>sudo nmcli connection add con-name 'Hotspot' ifname wlan0 type wifi slave-type bridge master bridge0 wifi.mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk wifi-sec.proto rsn wifi-sec.pairwise ccmp wifi-sec.psk &lt;hotspot-password&gt;</code></li>
</ul>
<h2 id="volume-management">Volume management</h2>
<ul>
<li>Swap file: <code>dd if=/dev/zero of=/swapfile32G bs=1024 count=32M</code></li>
<li><code>chmod 0600 swapfile32G</code></li>
<li><code>mkswap swapfile32G</code></li>
<li><code>dmsetup ls</code></li>
<li><code>sudo lvdisplay</code></li>
<li><code>lsblk --output NAME,KNAME,TYPE,SIZE,MOUNTPOINT</code></li>
<li><code>sudo dmsetup info ubuntu--vg-ubuntu--lv</code></li>
<li><code>lvdisplay</code></li>
<li><code>pvdisplay</code></li>
</ul>
<h3 id="raspberry-pi-set-swapfile">raspberry pi set swapfile</h3>
<ul>
<li><code>sudo nano /etc/dphys-swapfile: set CONF_SWAPSIZE=2048</code></li>
<li><code>sudo /etc/init.d/dphys-swapfile stop</code></li>
<li><code>sudo /etc/init.d/dphys-swapfile start</code></li>
</ul>
<h2 id="unix">unix</h2>
<ul>
<li><code>usermod -a -G sudo colleymj</code></li>
<li><code>arp -n</code></li>
<li><code>ip link show</code></li>
<li><code>route</code></li>
<li><code>ip route show</code></li>
<li><code>ip link show</code></li>
<li><code>ifconfig | grep -m 1 "^[a-z0-9]*:" | sed -e's/\(^[a-z0-9]*\):.*$/\1/' | xargs -I {} sh -c "ethtool {}"</code></li>
<li><code>ifconfig | grep -m 1 "^[a-z0-9]*:" | sed -e's/\(^[a-z0-9]*\):.*$/\1/' | xargs -I {} sh -c "sudo tcpdump -i {}"</code></li>
<li><code>ip address show</code></li>
<li><code>ip route show</code></li>
<li><code>ss -tunap</code></li>
<li><code>sudo lsof -i @james</code></li>
</ul>
<h2 id="postgres">Postgres</h2>
<p>kubectl rollout status deployment/postgres
/mnt/vagrant-kubernetes 192.168.50.0/24(rw,sync,no_subtree_check,insecure,no_root_squash)</p>
<p>export QAPPS_PASSWORD="<password>"
envsubst &lt; podzone-db.yaml | kubectl apply -f -</p>
<h2 id="manual-site-updates">Manual site updates</h2>
<pre><code class="language-bash">#!/bin/bash
mkdocs build
apachepod=`kubectl get pods -n default -o json |jq -r .items[].metadata.name | grep apache`
kubectl exec -n default $apachepod -- rm -R /var/www/html/podzone
kubectl -n default cp ~/workspace/podzone/site/ $apachepod:/tmp/podzone/
kubectl exec -n default $apachepod -- chown -R nobody:nogroup  /tmp/podzone/
kubectl exec -n default $apachepod -- mv /tmp/podzone  /var/www/html
kubectl exec apache-bf4996969-qnmqf -- rm -R /var/www/html/telling
kubectl cp ~/workspace/telling/site/ apache-bf4996969-qnmqf:/tmp/telling/
kubectl exec apache-bf4996969-qnmqf -- chown -R nobody:nogroup  /tmp/telling/
kubectl exec apache-bf4996969-qnmqf -- mv /tmp/telling  /var/www/html
kubectl cp ~/workspace/QApps/sites/index.html apache-bf4996969-qnmqf:/var/www.html/
</code></pre>
<h2 id="command-line-completion">Command line completion</h2>
<ul>
<li><code>source &lt;(kubectl completion bash)</code></li>
<li><code>echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</code></li>
</ul>
<h2 id="jenkinsx">Jenkinsx</h2>
<p>Github token for jenkinsx: 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</p>
<p>kubectl create secret docker-registry regcred --docker-server=<docker-server> --docker-username=<username> --docker-password=<password> --docker-email=<email></p>
<h2 id="zope">Zope</h2>
<p>Zope volume mounts:
./var/filestorage
./var/blobstorage
./products</p>
<p>kubectl cp ~/.factorio/saves/k8s-test.zip factorio/factorio-0:/factorio/saves/</p>
<p>kubectl cp ~/.factorio/saves/k8s-test.zip factorio/factorio-0:/factorio/saves/</p>
<h3 id="upgrade-note-did-not-result-in-rook-ceph-add-on-being-available">Upgrade: NOTE: did not result in rook-ceph add-on being available</h3>
<ul>
<li>sudo microk8s disable dashboard</li>
<li>microk8s disable metrics-server</li>
<li>microk8s kubectl drain sigiriya --ignore-daemonsets</li>
<li>sudo snap refresh microk8s --channel=1.28/stable</li>
<li>microk8s kubectl uncordon sigiriya</li>
</ul>
<h3 id="opensearch">Opensearch</h3>
<ul>
<li>Edit <code>https://github.com/opensearch-project/helm-charts/blob/main/charts/opensearch/values.yaml</code> for opensearch-bukit.yaml, opensearch-james.yaml, opensearch-sigiriya.yaml</li>
<li><code>helm repo add opensearch https://opensearch-project.github.io/helm-charts/</code></li>
<li><code>helm install opensearch-master opensearch/opensearch -f opensearch-bukit.yaml</code></li>
<li><code>helm install opensearch-client opensearch/opensearch -f opensearch-james.yaml</code></li>
<li><code>helm install opensearch-data opensearch/opensearch -f opensearch-sigiriya.yaml</code></li>
<li><code>helm install dashboards opensearch/opensearch-dashboards</code></li>
</ul>
<p>Opensearch dashboard:</p>
<p>Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=opensearch-dashboards,app.kubernetes.io/instance=dashboards" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT</p>
<p>token=$(kubectl -n kube-system get secret | grep default-token | cut -d " " -f1)  kubectl -n kube-system describe secret $token</p>
<p>kubectl logs --selector app=csi-nfs-controller -n kube-system -c nfs
kubectl logs --selector app=csi-nfs-node -n kube-system -c nfs</p>
<p>Observability has been enabled (user/pass: admin/prom-operator)</p>
<p>kubectl -n kube-system describe certificate kubernetes-dashboard-stg
kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard
kubectl -n kube-system logs -f $(kubectl -n kube-system get pods -l app=cert-manager -o jsonpath="{.items[0].metadata.name}") cert-manager
kube-system describe certificate kubernetes-dashboard-stg
kubectl logs  deployment/cert-manager  -n cert-manager
sudo microk8s kubectl describe secret -n kube-system microk8s-dashboard-token
kubectl logs podname -n namespace –all-containers=true
kubectl logs ingress-nginx-controller-7ddd87655-t2btf --all-containers --namespace ingress-nginx 
kubectl logs cert-manager-5d6bc46969-cqxnw -n cert-manager –all-containers=true
helm show values ingress-nginx --repo https://kubernetes.github.io/ingress-nginx
kubectl get L2Advertisement --all-namespaces -o yaml
kubectl get ipaddresspool --all-namespaces -o yaml
kubectl -n ingress-nginx get svc
kubectl describe pod cert-manager-5d6bc46969-xxxnt -n cert-manager
sudo microk8s kubectl config view --raw &gt; $HOME/.kube/config
calicoctl --allow-version-mismatch  get node -o yaml</p>
<p>/Users/martincolley/workspace/Certs/qsolutions/{cert1.pem, chain1.pem, fullchain1.pem, privkey1.pem}</p>
<p>kubectl create secret tls nginxsecret --key /Users/martincolley/workspace/Certs/qsolutions/privkey1.pem --cert /Users/martincolley/workspace/Certs/qsolutions/fullchain1.pem</p>
<p>kubectl create configmap nginxconfigmap --from-file=nginx-default.conf</p>
<p>brew install calicoctl</p>
<p>grep -B 15 -A 15 IP_AUTODETECTION_METHOD /var/snap/microk8s/current/args/cni-network/cni.yaml</p>
<p>kubectl create ingress demo-localhost --class=nginx --rule="levant/*=demo:80"</p>
<p>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml</p>
<p>nmcli connection add type bridge con-name localbr ifname localbr ipv4.method manual ipv4.addresses 10.13.31.1/24</p>
<p>sudo microk8s kubectl config view --raw &gt; $HOME/.kube/config
sudo usermod -a -G microk8s <username></p>
<p>multipass launch --network en0 --network name=bridge0,mode=manual</p>
<p>kubectl cluster-info dump</p>
<p>kubectl get pods -n kube-system -o wide</p>
<p>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml</p>
<p>sudo crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a
sudo crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a | grep kube | grep -v pause
sudo kubeadm init --control-plane-endpoint bukit --config kubeadm-config.yaml</p>
<p>/snap/docker/2893/bin/containerd config default</p>
<p>For snap docker installation (bukit):
sudo kubeadm init --cri-socket unix:/run/snap.docker/containerd/containerd.sock --control-plane-endpoint bukit --dry-run</p>
<p>For apt docker installation (james):
sudo kubeadm init --control-plane-endpoint bukit --dry-run</p>
<p>--config kubeadm-config.yaml</p>
<p>systemctl enable kubelet.service</p>
<p>kubectl version --client</p>
<p>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter</p>
<p>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sudo sysctl --system</p>
<ul>
<li>Kubernetes host network IP range <code>--service-cluster-ip-range=192.168.0.128/25</code> in  <code>/var/snap/microk8s/current/args/kube-apiserver</code></li>
<li><code>/var/snap/microk8s/current/args/cni-network/cni.yaml</code></li>
<li>edit <code>/var/snap/microk8s/current/args/kube-apiserver</code> and setting the following arguments:</li>
</ul>
<pre><code class="language-text"># /var/snap/microk8s/current/args/kube-apiserver
--advertise-address=10.10.10.10
--bind-address=0.0.0.0
--secure-port=16443
</code></pre>
<ul>
<li>CNI Pulgin: Calico, using 192.168.1.0/16: <code>kubeadm init --pod-network-cidr=192.168.1.0/16</code></li>
</ul>
<p>Full docker stack, packaged by docker: <code>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></p>
<p>Just runc and containerd, packaged by ubuntu: <code>apt-get -y install containerd</code></p>
<p>Containerd configuration requirements:</p>
<ul>
<li>Enable cri plugin in /etc/containerd/config.toml (achieved by overwriting the default file config.toml)</li>
<li>Set cgroup driver to Systemd</li>
<li>Configure k8s sandbox image</li>
</ul>
<p>The following achieves this:</p>
<pre><code class="language-text">cat &gt; /etc/containerd/config.toml &lt;&lt;EOF
[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
    SystemdCgroup = true
[plugins.&quot;io.containerd.grpc.v1.cri&quot;]
  sandbox_image = &quot;registry.k8s.io/pause:3.9&quot;
EOF
</code></pre>
<p>Restart containerd: <code>systemctl restart containerd</code></p>
<ul>
<li>Init command: kubeadm init --config kubeadm-config.yaml</li>
</ul>
<h3 id="tasks-cleanup-to-retdo-kubeadm-init">Tasks: Cleanup to retdo kubeadm init</h3>
<ul>
<li>kubectl drain <node name> --delete-emptydir-data --force --ignore-daemonsets</li>
<li>kubeadm reset </li>
<li>
<p>kubectl delete node <node name></p>
</li>
<li>
<p>clean /etc/cni/net.d</p>
</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
