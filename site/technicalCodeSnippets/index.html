<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Martin Colley" /><link rel="canonical" href="https://musings.thruhere.net/podzone/technicalCodeSnippets/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Command line snippets - Podzone</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Command line snippets";
        var mkdocs_page_input_path = "technicalCodeSnippets.md";
        var mkdocs_page_url = "/podzone/technicalCodeSnippets/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Podzone
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Requirements</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementIntroduction/">Introduction</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementBackground/">Background</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../requirementBusinessBrief/">QApps Business Brief</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTasklist1/">Task List: southern.podzone.net</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTasklist2/">Task List: northern.podzone.net</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Implementation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalKubernetes/">Kubernetes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalConsumerCloud/">Consumer Cloud</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalApplication/">Application Build</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalCeph/">Persistent data</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalCluster/">Implementation Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalExternalServices/">External Services</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIngress/">Ingress</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIoT/">Rust on the uNode embedded controller development board</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalIssues/">Issues</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalNFS/">Deprecated</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalNetwork/">Network Topology</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalPrometheus/">Prometheus Implementation Notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalSiteStructure/">Podzone Sites</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalStaticSite/">Wrapping static site functionality into a helm chart</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalTools/">Tools</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalWireguard/">Wireguard installation notes</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../technicalWordpress/">Installing Wordpress</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Inventory</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../inventorySite/">Site Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryHosts/">Hosts Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryIoT/">IoT (Internet of Things) devices</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryServers/">Server Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryVm/">Virtual Machine Inventory</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryWorkstation/">Workstation config</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../inventoryCosting/">Costing</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">References</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesApplication/">Application references</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesIoT/">Edge and IoT References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesResearch/">Research References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesReserve/">Reserve References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../referencesTroubleshooting/">Troubleshooting References</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Podzone</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Command line snippets</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="command-line-snippets">Command line snippets</h1>
<h2 id="microk8s">microk8s</h2>
<p>sudo snap install microk8s --channel=1.28/stable --classic</p>
<h2 id="helm">helm</h2>
<p>helm repo add truecharts https://charts.truecharts.org/
helm pull [chart URL | repo/chartname] [...] [flags]
helm package static-site
cloudsmith push helm q-solutions/static-site static-site-0.1.0.tgz
helm  install musings-01 --debug  --namespace musings --create-namespace static-site --repo 'https://dl.cloudsmith.io/public/q-solutions/static-site/helm/charts/'
helm install podzone-01 --debug --namespace podzone --create-namespace --values valuespodzone.yaml . 
helm  install podzone-01 --debug  --namespace podzone static-site --repo 'https://dl.cloudsmith.io/public/q-solutions/static-site/helm/charts/' -f values.yaml --values valuespodzone.yaml</p>
<p>helm upgrade --install <service> -f values.yaml <service>-9.0.xx.tgz --values <new file name>.yaml
helm  install orange-base --debug  --namespace musings qapps --repo 'https://dl.cloudsmith.io/public/q-solutions/qapps/helm/charts/'
helm  install orange-base --debug  --namespace musings ./qapps</p>
<h2 id="ceph">ceph</h2>
<p>sudo ceph config set mgr mgr/prometheus/server_addr sigiriya
sudo ceph config set mgr mgr/prometheus/port 9090</p>
<p>https://docs.ceph.com/en/quincy/rados/operations/pools/#create-a-pool</p>
<p>mount.ceph name@07fe3187-00d9-42a3-814b-72a4d5e7d5be.fs_name=/ /mnt/mycephfs -o mon_addr=1.2.3.4</p>
<p>sudo pro attach C13Nfcn8of2NLX4ZQbpN3zkEcT3WJZ</p>
<p>Mount apple volume - <code>./apfs-fuse /dev/sdb2 /mt/sdb1</code></p>
<h2 id="kubectl">kubectl</h2>
<p>kubectl config set-context --current --namespace=<namespace-name>
kubectl config set-context --current --namespace=admin
kubectl drain --ignore-daemonsets <node name>
kubectl uncordon <node name>
kubectl get -n default serviceaccount kubeapps-operator -o yaml
kubectl get pods --all-namespaces -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort | uniq -c</p>
<ul>
<li>Aliases: <code>alias ka="kubectl apply -f "</code>; <code>alias kd="kubectl delete -f "</code></li>
</ul>
<h2 id="ansible">ansible</h2>
<p>ansible southcluster -i inventory.yaml -m command -a "free -m"</p>
<p>To accept new ssh keys:
ANSIBLE_HOST_KEY_CHECKING=false ansible all -m ping -i inventory.yaml</p>
<p>ansible-playbook -i inventory.yaml playbook.yaml
ansible-inventory -i inventory.yaml --list
ansible devcluster -m ping -i inventory.yaml</p>
<h2 id="plone">plone</h2>
<p>/usr/local/Plone/Python-2.7/bin/python /usr/local/Plone/zinstance/parts/instance/bin/interpreter /usr/local/Plone/buildout-cache/eggs/zdaemon-2.0.7-py2.7.egg/zdaemon/zdrun.py -S /usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/zopeschema.xml -b 10 -d -s /usr/local/Plone/zinstance/var/instance/zopectlsock -x 0,2 -z /usr/local/Plone/zinstance/parts/instance /usr/local/Plone/Python-2.7/bin/python /usr/local/Plone/zinstance/parts/instance/bin/interpreter /usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/run.py -C /usr/local/Plone/zinstance/parts/instance/etc/zope.conf
/usr/local/Plone/Python-2.7/bin/python 
/usr/local/Plone/zinstance/parts/instance/bin/interpreter 
/usr/local/Plone/buildout-cache/eggs/Zope2-2.13.24-py2.7.egg/Zope2/Startup/run.py -C /usr/local/Plone/zinstance/parts/instance/etc/zope.conf
docker pull robcast/legacy-zope
docker pull robcast/legacy-zope:2.13</p>
<p>sudo usermod -aG sudo c</p>
<p>kubectl api-resources</p>
<h2 id="vagrant">Vagrant</h2>
<p>vagrant init techchad2022/ubuntu2204
vagrant up
useradd -p <password> <username>
vagrant destroy</p>
<p>echo vagrant ALL=NOPASSWD:ALL &gt; /etc/sudoers.d/vagrant
echo colleymj ALL=NOPASSWD:ALL &gt; /etc/sudoers.d/colleymj</p>
<p>To allow IP to be assigned via DHCP simply use:
config.vm.network "public_network"
This way you don't need to deal with mac address, it will be generated on its own. If you need custom mac address attached to the network device then:
config.vm.network "public_network", :mac=&gt; "080027xxxxxx"</p>
<h2 id="network-wi-fi-hot-spot">Network, wi-fi hot-spot</h2>
<p>sudo nmcli connection add type bridge con-name 'Bridge' ifname bridge0
sudo nmcli connection add type ethernet slave-type bridge con-name 'Ethernet' ifname eth0 master bridge0
sudo nmcli connection add con-name 'Hotspot' ifname wlan0 type wifi slave-type bridge master bridge0 wifi.mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk wifi-sec.proto rsn wifi-sec.pairwise ccmp wifi-sec.psk 61519400
sudo nmcli connection add type ethernet slave-type bridge   con-name 'Ethernet' ifname eth0 master bridge0
sudo nmcli connection add con-name 'Hotspot'  \
   ifname wlan0 type wifi slave-type bridge master bridge0  \
   wifi.mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk  \
   wifi-sec.proto rsn wifi-sec.pairwise ccmp     wifi-sec.psk 61519400</p>
<p>sudo nmcli device wifi hotspot ssid podzone password xxx11111</p>
<p>sudo nmcli connection add con-name 'Hotspot' \
    ifname wlan0 type wifi slave-type bridge master bridge0 \
    wifi.mode ap wifi.ssid Hotspot wifi-sec.key-mgmt wpa-psk \
    wifi-sec.proto rsn wifi-sec.pairwise ccmp \
    wifi-sec.psk <hotspot-password></p>
<h2 id="volume-management">Volume management</h2>
<p>Swap file: `dd if=/dev/zero of=/swapfile32G bs=1024 count=32M``
chmod 0600 swapfile32G
mkswap swapfile32G</p>
<p>dmsetup ls
sudo lvdisplay
lsblk --output NAME,KNAME,TYPE,SIZE,MOUNTPOINT
sudo dmsetup info ubuntu--vg-ubuntu--lv
lvdisplay
pvdisplay</p>
<p>raspberry pi set swapfile
sudo nano /etc/dphys-swapfile: set CONF_SWAPSIZE=2048
sudo /etc/init.d/dphys-swapfile stop
sudo /etc/init.d/dphys-swapfile start</p>
<h2 id="unix">unix</h2>
<p>usermod -a -G sudo colleymj</p>
<p>arp -n
ip link show
route
ip route show</p>
<p>ip link show
ifconfig | grep -m 1 "^[a-z0-9]<em>:" | sed -e's/(^[a-z0-9]</em>):.<em>$/\1/' | xargs -I {} sh -c "ethtool {}"
ifconfig | grep -m 1 "^[a-z0-9]</em>:" | sed -e's/(^[a-z0-9]<em>):.</em>$/\1/' | xargs -I {} sh -c "sudo tcpdump -i {}"</p>
<p>ip address show
ip route show
ss -tunap
sudo lsof -i @james</p>
<h2 id="postgres">Postgres</h2>
<p>kubectl rollout status deployment/postgres
/mnt/vagrant-kubernetes 192.168.50.0/24(rw,sync,no_subtree_check,insecure,no_root_squash)</p>
<p>export QAPPS_PASSWORD="<password>"
envsubst &lt; podzone-db.yaml | kubectl apply -f -</p>
<h2 id="manual-site-updates">Manual site updates</h2>
<h1 id="binbash">!/bin/bash</h1>
<p>mkdocs build
apachepod=<code>kubectl get pods -n default -o json |jq -r .items[].metadata.name | grep apache</code>
kubectl exec -n default $apachepod -- rm -R /var/www/html/podzone
kubectl -n default cp ~/workspace/podzone/site/ $apachepod:/tmp/podzone/
kubectl exec -n default $apachepod -- chown -R nobody:nogroup  /tmp/podzone/
kubectl exec -n default $apachepod -- mv /tmp/podzone  /var/www/html</p>
<p>kubectl exec apache-bf4996969-qnmqf -- rm -R /var/www/html/telling
kubectl cp ~/workspace/telling/site/ apache-bf4996969-qnmqf:/tmp/telling/
kubectl exec apache-bf4996969-qnmqf -- chown -R nobody:nogroup  /tmp/telling/
kubectl exec apache-bf4996969-qnmqf -- mv /tmp/telling  /var/www/html</p>
<p>kubectl cp ~/workspace/QApps/sites/index.html apache-bf4996969-qnmqf:/var/www.html/</p>
<h2 id="command-line-completion">Command line completion</h2>
<p>source &lt;(kubectl completion bash)
echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc</p>
<h2 id="jenkinsx">Jenkinsx</h2>
<p>Github token for jenkinsx: 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</p>
<p>kubectl create secret docker-registry regcred --docker-server=<docker-server> --docker-username=<username> --docker-password=<password> --docker-email=<email></p>
<h2 id="zope">Zope</h2>
<p>Zope volume mounts:
./var/filestorage
./var/blobstorage
./products</p>
<p>kubectl cp ~/.factorio/saves/k8s-test.zip factorio/factorio-0:/factorio/saves/</p>
<p>kubectl cp ~/.factorio/saves/k8s-test.zip factorio/factorio-0:/factorio/saves/</p>
<h3 id="upgrade-note-did-not-result-in-rook-ceph-add-on-being-available">Upgrade: NOTE: did not result in rook-ceph add-on being available</h3>
<ul>
<li>sudo microk8s disable dashboard</li>
<li>microk8s disable metrics-server</li>
<li>microk8s kubectl drain sigiriya --ignore-daemonsets</li>
<li>sudo snap refresh microk8s --channel=1.28/stable</li>
<li>microk8s kubectl uncordon sigiriya</li>
</ul>
<h3 id="opensearch">Opensearch</h3>
<ul>
<li>Edit <code>https://github.com/opensearch-project/helm-charts/blob/main/charts/opensearch/values.yaml</code> for opensearch-bukit.yaml, opensearch-james.yaml, opensearch-sigiriya.yaml</li>
<li><code>helm repo add opensearch https://opensearch-project.github.io/helm-charts/</code></li>
<li><code>helm install opensearch-master opensearch/opensearch -f opensearch-bukit.yaml</code></li>
<li><code>helm install opensearch-client opensearch/opensearch -f opensearch-james.yaml</code></li>
<li><code>helm install opensearch-data opensearch/opensearch -f opensearch-sigiriya.yaml</code></li>
<li><code>helm install dashboards opensearch/opensearch-dashboards</code></li>
</ul>
<h2 id="opensearch_1">Opensearch</h2>
<p>Opensearch dashboard:</p>
<p>Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/name=opensearch-dashboards,app.kubernetes.io/instance=dashboards" -o jsonpath="{.items[0].metadata.name}")
  export CONTAINER_PORT=$(kubectl get pod --namespace default $POD_NAME -o jsonpath="{.spec.containers[0].ports[0].containerPort}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl --namespace default port-forward $POD_NAME 8080:$CONTAINER_PORT</p>
<p>token=$(kubectl -n kube-system get secret | grep default-token | cut -d " " -f1)  kubectl -n kube-system describe secret $token</p>
<p>kubectl logs --selector app=csi-nfs-controller -n kube-system -c nfs
kubectl logs --selector app=csi-nfs-node -n kube-system -c nfs</p>
<p>Observability has been enabled (user/pass: admin/prom-operator)</p>
<p>kubectl -n kube-system describe certificate kubernetes-dashboard-stg
kubectl create clusterrolebinding add-on-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard
kubectl -n kube-system logs -f $(kubectl -n kube-system get pods -l app=cert-manager -o jsonpath="{.items[0].metadata.name}") cert-manager
kube-system describe certificate kubernetes-dashboard-stg
kubectl logs  deployment/cert-manager  -n cert-manager
sudo microk8s kubectl describe secret -n kube-system microk8s-dashboard-token
kubectl logs podname -n namespace –all-containers=true
kubectl logs ingress-nginx-controller-7ddd87655-t2btf --all-containers --namespace ingress-nginx 
kubectl logs cert-manager-5d6bc46969-cqxnw -n cert-manager –all-containers=true
helm show values ingress-nginx --repo https://kubernetes.github.io/ingress-nginx
kubectl get L2Advertisement --all-namespaces -o yaml
kubectl get ipaddresspool --all-namespaces -o yaml
kubectl -n ingress-nginx get svc
kubectl describe pod cert-manager-5d6bc46969-xxxnt -n cert-manager
sudo microk8s kubectl config view --raw &gt; $HOME/.kube/config
calicoctl --allow-version-mismatch  get node -o yaml</p>
<p>/Users/martincolley/workspace/Certs/qsolutions/{cert1.pem, chain1.pem, fullchain1.pem, privkey1.pem}</p>
<p>kubectl create secret tls nginxsecret --key /Users/martincolley/workspace/Certs/qsolutions/privkey1.pem --cert /Users/martincolley/workspace/Certs/qsolutions/fullchain1.pem</p>
<p>kubectl create configmap nginxconfigmap --from-file=nginx-default.conf</p>
<p>brew install calicoctl</p>
<p>grep -B 15 -A 15 IP_AUTODETECTION_METHOD /var/snap/microk8s/current/args/cni-network/cni.yaml</p>
<p>kubectl create ingress demo-localhost --class=nginx --rule="levant/*=demo:80"</p>
<p>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml</p>
<p>nmcli connection add type bridge con-name localbr ifname localbr ipv4.method manual ipv4.addresses 10.13.31.1/24</p>
<p>sudo microk8s kubectl config view --raw &gt; $HOME/.kube/config
sudo usermod -a -G microk8s <username></p>
<p>multipass launch --network en0 --network name=bridge0,mode=manual</p>
<p>kubectl cluster-info dump</p>
<p>kubectl get pods -n kube-system -o wide</p>
<p>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml</p>
<p>sudo crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a
sudo crictl --runtime-endpoint unix:///var/run/containerd/containerd.sock ps -a | grep kube | grep -v pause
sudo kubeadm init --control-plane-endpoint bukit --config kubeadm-config.yaml</p>
<p>/snap/docker/2893/bin/containerd config default</p>
<p>For snap docker installation (bukit):
sudo kubeadm init --cri-socket unix:/run/snap.docker/containerd/containerd.sock --control-plane-endpoint bukit --dry-run</p>
<p>For apt docker installation (james):
sudo kubeadm init --control-plane-endpoint bukit --dry-run</p>
<p>--config kubeadm-config.yaml</p>
<p>systemctl enable kubelet.service</p>
<p>kubectl version --client</p>
<p>cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter</p>
<p>cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF
sudo sysctl --system</p>
<ul>
<li>Kubernetes host network IP range <code>--service-cluster-ip-range=192.168.0.128/25</code> in  <code>/var/snap/microk8s/current/args/kube-apiserver</code></li>
<li><code>/var/snap/microk8s/current/args/cni-network/cni.yaml</code></li>
<li>edit <code>/var/snap/microk8s/current/args/kube-apiserver</code> and setting the following arguments:</li>
</ul>
<p><div class="highlight"><pre><span></span><code># /var/snap/microk8s/current/args/kube-apiserver
--advertise-address=10.10.10.10
--bind-address=0.0.0.0
--secure-port=16443
</code></pre></div>
- CNI Pulgin: Calico, using 192.168.1.0/16: <code>kubeadm init --pod-network-cidr=192.168.1.0/16</code></p>
<h3 id="k8s-installation">k8s installation</h3>
<ul>
<li>[X] bukit and james: Install kubeadm and kubelet: <code>sudo apt-get install -y kubelet kubeadm</code></li>
<li>[X] bukit: Swap settings for kubeadm (sudo swapoff -a; comment out /swapfile in /etc/fstab)</li>
<li>[X] bukit: Configure kubeadm for containerd  (create kubeadm-config.yaml)</li>
<li>[ ] bukit: kubeadm init  --config kubeadm-config.yaml</li>
<li>[ ] dolmen: Install kubectl</li>
<li>[ ] Add third cluster node (virtual box on )</li>
</ul>
<h3 id="tasks-cleanup-to-retry-kubeadm-init">Tasks: Cleanup to retry kubeadm init</h3>
<h3 id="tasks-cleanup-initial">Tasks: Cleanup initial</h3>
<ul>
<li>[X] james: snap cleanup</li>
<li>[X] bukit: <code>snap remove kube-apiserver kubectl</code></li>
<li>[X] james: Remove docker, kubectl, and k8s components</li>
<li>[X] bukit: Remove docker, kubectl, and k8s components</li>
<li>[X] bukit and james: Clean up k8s files (/var/lib/kubelet/; /etc/kubernetes/)</li>
<li>[X] bukit and james: Clean up docker installation files <code>rm -rf /var/lib/containerd</code> and  <code>rm -rf /var/lib/docker</code></li>
<li>[X] bukit and james: Clean up etcd files <code>rm -rf /var/lib/etcd</code></li>
<li>[ ] bukit: ~/.kube and ~/.microk8s</li>
</ul>
<h3 id="tasks-prep-for-k8s-installation">Tasks: Prep for k8s installation</h3>
<ul>
<li>[X] bukit, dolmen and james: /etc/hosts file configs for james and bukit /private/etc/hosts for dolmen</li>
<li>[X] james: Install containerd</li>
<li>[X] bukit: Install containerd</li>
<li>[X] james: Configure containerd (/etc/containerd/config.toml)</li>
<li>[X] bukit: Configure containerd (/etc/containerd/config.toml)</li>
</ul>
<h2 id="containerd-installation-and-configuration">Containerd installation and configuration</h2>
<p>Full docker stack, packaged by docker: <code>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</code></p>
<p>Just runc and containerd, packaged by ubuntu: <code>apt-get -y install containerd</code></p>
<p>Containerd configuration requirements:</p>
<ul>
<li>Enable cri plugin in /etc/containerd/config.toml (achieved by overwriting the default file config.toml)</li>
<li>Set cgroup driver to Systemd</li>
<li>Configure k8s sandbox image</li>
</ul>
<p>The following achieves this:</p>
<div class="highlight"><pre><span></span><code>cat &gt; /etc/containerd/config.toml &lt;&lt;EOF
[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
    SystemdCgroup = true
[plugins.&quot;io.containerd.grpc.v1.cri&quot;]
  sandbox_image = &quot;registry.k8s.io/pause:3.9&quot;
EOF
</code></pre></div>
<p>Restart containerd: <code>systemctl restart containerd</code></p>
<h2 id="kubeadm-installation-and-configuration">kubeadm installation and configuration</h2>
<ul>
<li>Set Pod subnet (--pod-network-cidr): 192.168.1.0/24</li>
<li>Set Service subnet 192.168.0.0/24</li>
<li>Set --control-plane-endpoint bukit</li>
<li>Set systemd as the cgroup driver</li>
<li>Since the config file option to init is required for cgroup driver, create a config file for all options:</li>
</ul>
<div class="highlight"><pre><span></span><code>kind: ClusterConfiguration
apiVersion: kubeadm.k8s.io/v1beta3
kubernetesVersion: v1.28.2
networking:
  serviceSubnet: &quot;192.168.0.0/24&quot;
  podSubnet: &quot;192.168.1.0/24&quot;
  dnsDomain: &quot;cluster.local&quot;
controlPlaneEndpoint: &quot;bukit&quot;
clusterName: &quot;qapps-cluster&quot;
---
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
cgroupDriver: systemd
</code></pre></div>
<ul>
<li>Init command: kubeadm init --config kubeadm-config.yaml</li>
</ul>
<h3 id="tasks-cleanup-to-retdo-kubeadm-init">Tasks: Cleanup to retdo kubeadm init</h3>
<ul>
<li>kubectl drain <node name> --delete-emptydir-data --force --ignore-daemonsets</li>
<li>kubeadm reset </li>
<li>
<p>kubectl delete node <node name></p>
</li>
<li>
<p>clean /etc/cni/net.d</p>
</li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
